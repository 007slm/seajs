<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<title>SeaJS Test Suite</title>
<link rel="stylesheet" href="style.css"/>
<script src="config.js"></script>
</head>
<body>
<div id="container">
  <div id="header">
    <h1 id="title">Test Suite for SeaJS</h1>
    <div id="summary"></div>
  </div>
  <div id="reporter"></div>
  <button id="go" class="btn" autocomplete="off">Go</button>
  <input id="hide-pass" type="checkbox">
  <label for="hide-pass">Hide passed</label>
  <p id="info"></p>
</div>

<script>

(function(global) {
  var result = global.result = {}
  var currentPage, isRunning, timeoutTimer
  var startTime, endTime
  var consoleMode = location.search.indexOf('console') > 0

  var container = document.getElementById('container')
  var summary = document.getElementById('summary')
  var reporter = document.getElementById('reporter')

  document.getElementById('info').innerHTML = navigator.userAgent

  document.getElementById('hide-pass').onclick = function() {
    reporter.className = this.checked ? 'hide-pass' : ''
  }

  document.getElementById('go').onclick = function() {
    if (currentPage === 0) {
      start()
    }
    else {
      isRunning ? pause() : next()
    }
  }


  global.onload = start


  function start() {
    reporter.innerHTML = ''
    reset()
    startTime = now()
    next()
  }

  function next() {
    isRunning = true
    go.innerHTML = 'Pause'
    testNextPage()
  }

  function pause() {
    isRunning = false
    go.innerHTML = 'Resume'
  }

  function reset() {
    currentPage = 0
    result.pass = { count: 0, cases: [] }
    result.fail = { count: 0, cases: [] }
    result.warn = { count: 0, cases: [] }
    result.error = { count: 0, cases: [] }

    isRunning = false
    go.innerHTML = 'Go'
    timeoutTimer = 0
  }


  global.testNextPage = function() {
    var page = testPages[currentPage++]
    clearTimeout(timeoutTimer)
    clear()

    if (page) {
      // Paused
      if (isRunning === false) {
        printResults('[PAUSED]', 'warn')
        printStepInfo()
        printErrors()
        return
      }

      // Load page
      var url = getUrl(page)
      printHeader(page, url, 'h2')
      load(url)
      makeSureGoOn(page)

      printStepInfo()
    }
    // All done
    else {
      endTime = now()
      printStepInfo()
      printErrors()
      printHeader('END', '', 'h2')
      reset()
    }
  }

  global.printResults = function(txt, style, stopped) {
    var d = document.createElement('div')
    d.innerHTML = txt
    d.className = style

    reporter.appendChild(d)
    scroll()

    if (!stopped) {
      var r = result[style]
      if (r) {
        r.count += 1
        r.cases.push(testPages[currentPage - 1])
      }
    }

    consoleMode && print2Console(txt, style)
  }

  global.printHeader = function(test, url, tag) {
    var h = document.createElement(tag || 'h3')
    h.innerHTML = test +
        (url ? ' <a class="hash" target="_blank" href="' + url + '">#</a>' : '')

    reporter.appendChild(h)
    scroll()

    consoleMode && print2Console(test)
  }


  // Helpers

  function getUrl(page) {
    return page + '/test.html' + '?t=' + now()
  }

  function clear() {
    var iframes = document.getElementsByTagName('iframe')
    var length = iframes.length

    for (var i = 0; i < length; i++) {
      iframes[i].parentNode.removeChild(iframes[i])
    }
  }

  function load(url) {
    var frame = document.createElement('iframe')
    container.appendChild(frame)
    frame.src = url
  }

  function printStepInfo() {
    var test = testPages[currentPage - 1]

    var html = summary.innerHTML =
        (currentPage - 1) + ' / ' + testPages.length + ' { &nbsp;' +
            'Passed: <span class="pass">' + result.pass.count + '</span> ' +
            'Failed: <span class="fail">' + result.fail.count + '</span> ' +
            'Errors: <span class="error">' + result.error.count + '</span>}' +
            '&nbsp; ' +
            (test ?
                'Running ' + test + ' ... ' :
                'Elapsed Time: ' + (endTime - startTime) / 1000 + 's')

    if (!test && consoleMode) {
      printHeader('Summary', '', 'h2')
      print2Console(html.replace(/&nbsp;/g, '').replace(/<\/?span[^>]*>/g, ''))
    }
  }

  function printErrors() {
    if (result.fail.count + result.error.count + result.warn.count === 0) return
    printHeader('Error Cases:', '', 'h2')

    for (var type in result) {
      if (type === 'pass') continue
      var obj = result[type]

      if (obj.count) {
        var cases = obj.cases

        for (var i = 0; i < cases.length; i++) {
          var test = cases[i]
          printResults('[' + type.toUpperCase() + '] ' + test + ' ' +
              (consoleMode ?
                  getUrl(test) :
                  '<a class="hash" target="_blank" href="' + getUrl(test) + '">#</a>'),
              type, true)
        }
      }
    }

    printResults('[DONE]')
  }

  function makeSureGoOn(test) {
    // Wait 10s
    timeoutTimer = setTimeout(function() {
      printResults('[WARN] Time is out for this test case: ' + test, 'warn')
      testNextPage()
    }, 10000)
  }

  function print2Console(msg, type) {
    if (type !== 'warn' && type !== 'error') {
      type = 'log'
    }
    console[type](msg)
  }

  function scroll() {
    reporter.scrollTop = reporter.scrollHeight
  }

  function now() {
    return new Date().getTime()
  }

})(this)
</script>
</body>
</html>