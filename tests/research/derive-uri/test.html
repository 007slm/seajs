<!doctype html>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=0">
<title>onload order</title>
<link rel="stylesheet" href="../../style.css">
<script src="../../test.js"></script>
<script> var print = test.print </script>
</head>
<body>
<div id="out"></div>

<!-- cache some scripts -->
<script> var cacheScript = true </script>
<script src="a.js"></script>
<script src="b.js"></script>
<script src="c.js"></script>
<script src="h.js"></script>
<script> cacheScript = false </script>

<script>
  var outEl = document.getElementById('out')
  var out = []
  var n = 0
  var N = 9


  fetch('a.js', printOnload('a.js'))

  fetch('d.js', function() {
    fetch('b.js', printOnload('b.js'))
    printOnload('d.js')()
    fetch('g.js', printOnload('g.js'))
  })

  fetch('e.js', printOnload('e.js'))
  fetch('f.js', printOnload('f.js'))

  fetch('h.js', function() {
    fetch('i.js', printOnload('i.js'))
    printOnload('h.js')()
  })


  function done() {
    if (++n === N) {
      print('----------------------------------------------------------------')

      var s = out.join('')
      var U = s.replace(/[a-z]/g, '')
      var L = s.replace(/[A-Z]/g, '')

      // 测试基本信息
      test.assert(s.length === 2 * N, s + ' ' + U + ' ' + L)
      test.assert(U.length === N, U.length)
      test.assert(L.length === N, L.length)

      // 测试 A < a 的可靠性
      var chars = U.split('')
      for (var i = 0; i < chars.length; i++) {
        var u = chars[i]
        var l = u.toLowerCase()
        test.assert(s.indexOf(u) < s.indexOf(l), u + ' < ' + l)
      }

      // 测试顺序一致性
      test.assert(U.toLowerCase() === L, '"' + U + '".toLowerCase() === "' + L + '"')

      // Aa 紧相邻假设
      // 1. 在某些低版本浏览器下不能保证，比如 iPhone 一代的 Safari 上
      // 2. 在 IE6-9 下不能保证
      for (i = 0; i < chars.length; i++) {
        u = chars[i]
        l = u.toLowerCase()
        test.assert(s.indexOf(l) - s.indexOf(u) === 1, l + ' - ' + u + ' = 1')
      }

      print('EOF')
      test.next()
    }
  }

  function fetch(src, callback) {
    var node = document.createElement('script')
    addOnload(node, callback)
    node.src = src
    outEl.appendChild(node)
  }

  function addOnload(node, callback) {
    if (node.addEventListener) {
      node.addEventListener('load', callback, false)
      node.addEventListener('error', function() {
        print('error: ' + node.src)
        out.push(0)
      }, false)
    }
    else { // for IE6-8
      node.attachEvent('onreadystatechange', function() {
        var rs = node.readyState
        if (rs === 'loaded' || rs === 'complete') {
          callback()
        }
      })
    }
  }

  function printOnload(file) {
    return function() {
      print(file + ' is loaded')
      out.push(file.split('.')[0])
      done()
    }
  }

</script>
</body>
</html>