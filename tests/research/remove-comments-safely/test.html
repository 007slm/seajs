<!doctype html>
<html>
<head>
<meta charset="utf-8">
<title>Comment Removal</title>
<style>
  body {
    font-size: .8em;
    padding: 10px;
    margin: 0;
    font-family: "Consolas", "Lucida Console", Courier, monospace;
  }

  #a {
    width: 700px;
    height: 250px;
    font-size: 1em;
    padding: 10px;
  }

  #b {
    display: block;
    font-size: 1.4em;
  }

  #c {
    color: white;
    padding: 10px;
    background: #222;
    width: 700px;
  }
</style>
</head>

<body>
<h1>Comment Removal</h1>

<textarea id="a">
  /**
  * @fileoverview Module authoring format.
  */

  var define = function() {
  // some comment
  var reg = /.*/g; // comment */
  }

  /* ok, I will disappear. */
  var s = '// i am string'; require('xx');
  var t = 'i am string too'; // require('zz');

  /* will not // be removed */ var xx = 'a';

  //
  //     var Calendar = require('calendar');

  /*@cc_on @*/
  var str = " /* not a real comment */ ";
  var regex = /\/*.*/;
  var z = '"\'';
</textarea>
<button id="b">Remove Comments</button>
<pre id="c"></pre>

<script>

  $ = function(id) {
    return document.getElementById(id)
  }

  $('b').onclick = function() {
    $('c').innerHTML = removeComments($('a').value).replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br/>')
  }

  function removeComments(code) {
    return code.replace(/(\/\*([\s\S]*?)\*\/|([^:]|^)\/\/(.*)$)/mg, '')
  }

  function removeComments2(code) {
    // multi-line comments
    code = code.replace(/^\s*\/\*[\s\S]*?\*\/\s*$/mg, '')

    // single-line comments
    code = code.replace(/^\s*\/\/.*$/mg, '')

    return code
  }

  // http://james.padolsey.com/javascript/removing-comments-in-javascript/
  function removeComments3(str) {
      str = ('__' + str + '__').split('');
      var mode = {
          singleQuote: false,
          doubleQuote: false,
          regex: false,
          blockComment: false,
          lineComment: false,
          condComp: false
      };
      for (var i = 0, l = str.length; i < l; i++) {

          if (mode.regex) {
              if (str[i] === '/' && str[i - 1] !== '\\') {
                  mode.regex = false;
              }
              continue;
          }

          if (mode.singleQuote) {
              if (str[i] === "'" && str[i - 1] !== '\\') {
                  mode.singleQuote = false;
              }
              continue;
          }

          if (mode.doubleQuote) {
              if (str[i] === '"' && str[i - 1] !== '\\') {
                  mode.doubleQuote = false;
              }
              continue;
          }

          if (mode.blockComment) {
              if (str[i] === '*' && str[i + 1] === '/') {
                  str[i + 1] = '';
                  mode.blockComment = false;
              }
              str[i] = '';
              continue;
          }

          if (mode.lineComment) {
              if (str[i + 1] === '\n' || str[i + 1] === '\r') {
                  mode.lineComment = false;
              }
              str[i] = '';
              continue;
          }

          if (mode.condComp) {
              if (str[i - 2] === '@' && str[i - 1] === '*' && str[i] === '/') {
                  mode.condComp = false;
              }
              continue;
          }

          mode.doubleQuote = str[i] === '"';
          mode.singleQuote = str[i] === "'";

          if (str[i] === '/') {

              if (str[i + 1] === '*' && str[i + 2] === '@') {
                  mode.condComp = true;
                  continue;
              }
              if (str[i + 1] === '*') {
                  str[i] = '';
                  mode.blockComment = true;
                  continue;
              }
              if (str[i + 1] === '/') {
                  str[i] = '';
                  mode.lineComment = true;
                  continue;
              }
              mode.regex = true;

          }

      }
      return str.join('').slice(2, -2);
  }

  // http://james.padolsey.com/javascript/javascript-comment-removal-revisted/
  function removeComments4(str) {
      var uid = '_' + +new Date(),
              primatives = [],
              primIndex = 0;

      return (
              str
                  /* Remove strings */
                      .replace(/(['"])(\\\1|.)+?\1/g, function(match) {
                          primatives[primIndex] = match;
                          return (uid + '') + primIndex++;
                      })

                  /* Remove Regexes */
                      .replace(/([^\/])(\/(?!\*|\/)(\\\/|.)+?\/[gim]{0,3})/g, function(match, $1, $2) {
                          primatives[primIndex] = $2;
                          return $1 + (uid + '') + primIndex++;
                      })

                  /*
                   - Remove single-line comments that contain would-be multi-line delimiters
                   E.g. // Comment /* <--
                   - Remove multi-line comments that contain would be single-line delimiters
                   E.g. /* // <--
                   */
                      .replace(/\/\/.*?\/?\*.+?(?=\n|\r|$)|\/\*[\s\S]*?\/\/[\s\S]*?\*\//g, '')

                  /*
                   Remove single and multi-line comments,
                   no consideration of inner-contents
                   */
                      .replace(/\/\/.+?(?=\n|\r|$)|\/\*[\s\S]+?\*\//g, '')

                  /*
                   Remove multi-line comments that have a replaced ending (string/regex)
                   Greedy, so no inner strings/regexes will stop it.
                   */
                      .replace(RegExp('\\/\\*[\\s\\S]+' + uid + '\\d+', 'g'), '')

                  /* Bring back strings & regexes */
                      .replace(RegExp(uid + '(\\d+)', 'g'), function(match, n) {
                          return primatives[n];
                      })
              );

  }


</script>


<h3>References</h3>

<ul>
  <li><a href="http://james.padolsey.com/javascript/removing-comments-in-javascript/">Removing comments in JavaScript</a> <a href="http://james.padolsey.com/demos/comment-removal-js.html">DEMO</a></li>
  <li><a href="https://github.com/seajs/seajs/issues/478">https://github.com/seajs/seajs/issues/478</a></li>
  <li><a href="http://jsperf.com/remove-comments">http://jsperf.com/remove-comments</a></li>
</ul>

</body>
</html>
